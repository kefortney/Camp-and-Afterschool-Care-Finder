<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äì Camp &amp; Afterschool Care Finder</title>
  <style>
    /* ===== Design Tokens (match main site) ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #2a7d4f;
      --primary-dark: #1e5e3a;
      --primary-light: #d6efe2;
      --bg: #f5f7f5;
      --white: #ffffff;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-400: #ced4da;
      --gray-600: #6c757d;
      --gray-800: #343a40;
      --text: #2c3e35;
      --danger: #b91c1c;
      --danger-bg: #fee2e2;
      --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.14);
      --radius: 10px;
      --radius-sm: 6px;
      --transition: 0.2s ease;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== Header ===== */
    header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 60%, #3a9e65 100%);
      color: var(--white);
      padding: 1.5rem 1.5rem 2rem;
      text-align: center;
    }
    .header-icon { font-size: 2.2rem; display: block; margin-bottom: 0.4rem; }
    header h1 { font-size: clamp(1.4rem, 3vw, 2rem); font-weight: 700; margin-bottom: 0.3rem; }
    header p.subtitle { font-size: 0.95rem; opacity: 0.88; }

    /* ===== Main ===== */
    main { max-width: 1300px; margin: 0 auto; padding: 1.5rem 1rem 3rem; }

    /* ===== Toolbar ===== */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }
    .search-box {
      flex: 1;
      min-width: 220px;
      position: relative;
    }
    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    .search-box input {
      width: 100%;
      padding: 0.6rem 1rem 0.6rem 2.2rem;
      border: 1.5px solid var(--gray-400);
      border-radius: var(--radius-sm);
      font-size: 0.92rem;
      background: var(--white);
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(42,125,79,0.15);
    }
    .toolbar-actions { display: flex; gap: 0.5rem; align-items: center; margin-left: auto; }

    /* ===== Buttons ===== */
    .btn-primary {
      background: var(--primary); color: var(--white);
      border: none; border-radius: var(--radius-sm);
      padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600;
      cursor: pointer; transition: background var(--transition);
      display: inline-flex; align-items: center; gap: 0.3rem;
    }
    .btn-primary:hover { background: var(--primary-dark); }

    .btn-secondary {
      background: none; border: 1.5px solid var(--gray-400);
      border-radius: var(--radius-sm); padding: 0.55rem 1rem;
      font-size: 0.9rem; font-weight: 600; cursor: pointer;
      color: var(--gray-800); transition: all var(--transition);
    }
    .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }

    .btn-danger {
      background: var(--danger); color: var(--white);
      border: none; border-radius: var(--radius-sm);
      padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600;
      cursor: pointer; transition: background var(--transition);
    }
    .btn-danger:hover { background: #991b1b; }

    .btn-icon {
      padding: 0.35rem 0.65rem; font-size: 0.82rem; font-weight: 600;
      border-radius: var(--radius-sm); cursor: pointer;
      transition: all var(--transition); border: 1.5px solid;
    }
    .btn-icon.edit  { background: var(--primary-light); color: var(--primary-dark); border-color: var(--primary-light); }
    .btn-icon.edit:hover { background: var(--primary); color: var(--white); }
    .btn-icon.del   { background: var(--danger-bg); color: var(--danger); border-color: var(--danger-bg); }
    .btn-icon.del:hover { background: var(--danger); color: var(--white); }

    /* ===== Dirty badge ===== */
    .dirty-badge {
      background: #fef3c7; color: #92400e;
      font-size: 0.78rem; font-weight: 600;
      padding: 0.2rem 0.7rem; border-radius: 20px;
      white-space: nowrap;
    }

    /* ===== Stats ===== */
    .stats { font-size: 0.88rem; color: var(--gray-600); margin-bottom: 0.75rem; }
    .stats strong { color: var(--text); }

    /* ===== Table ===== */
    .table-wrapper {
      overflow-x: auto;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
    thead th {
      background: var(--primary); color: var(--white);
      padding: 0.7rem 0.9rem; text-align: left;
      white-space: nowrap; position: sticky; top: 0; z-index: 1;
    }
    thead th.sortable { cursor: pointer; user-select: none; }
    thead th.sortable:hover { background: var(--primary-dark); }
    thead th .sort-indicator { margin-left: 0.3rem; opacity: 0.6; }
    thead th.sort-active .sort-indicator { opacity: 1; }
    tbody tr:nth-child(even) { background: var(--gray-100); }
    tbody tr:hover { background: var(--primary-light); }
    td {
      padding: 0.55rem 0.9rem;
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
    }
    .td-name { max-width: 240px; }
    .td-org  { max-width: 200px; }
    .td-trunc { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
    .td-actions { white-space: nowrap; display: flex; gap: 0.4rem; }
    .badge-camp { background: #dbeafe; color: #1d4ed8; }
    .badge-both { background: #ede9fe; color: #5b21b6; }
    .type-badge {
      display: inline-block; font-size: 0.7rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.05em;
      border-radius: 20px; padding: 0.15rem 0.55rem;
    }

    /* ===== Modal Overlay ===== */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: flex-start; justify-content: center;
      padding: 1.5rem 1rem; overflow-y: auto;
    }
    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-height: none;
      margin: auto;
      animation: modalIn 0.18s ease;
    }
    .modal-wide   { max-width: 820px; }
    .modal-narrow { max-width: 460px; }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.96) translateY(8px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-header {
      padding: 1.2rem 1.5rem 0.9rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { font-size: 1.15rem; font-weight: 700; }
    .modal-close {
      background: none; border: none; font-size: 1.3rem;
      cursor: pointer; color: var(--gray-600); padding: 0.2rem; line-height: 1;
    }
    .modal-close:hover { color: var(--text); }

    .modal-body {
      padding: 1.25rem 1.5rem;
      overflow-y: auto;
      max-height: calc(90vh - 130px);
    }

    .modal-footer {
      padding: 0.9rem 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex; gap: 0.75rem; justify-content: flex-end;
    }

    /* ===== Form ===== */
    fieldset {
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      padding: 0.9rem 1rem 0.7rem;
      margin-bottom: 0.85rem;
    }
    legend {
      font-size: 0.73rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--gray-600); padding: 0 0.4rem;
    }
    .form-row { display: flex; gap: 0.65rem; flex-wrap: wrap; margin-bottom: 0.55rem; }
    .form-row:last-child { margin-bottom: 0; }
    .form-group { display: flex; flex-direction: column; flex: 1; min-width: 130px; }
    .form-group.full { flex-basis: 100%; min-width: 100%; }
    .form-group.narrow { flex: 0 0 75px; min-width: 75px; }
    .form-group label {
      font-size: 0.74rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.04em;
      color: var(--gray-600); margin-bottom: 0.22rem;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.48rem 0.65rem;
      border: 1.5px solid var(--gray-400);
      border-radius: var(--radius-sm);
      font-size: 0.88rem; font-family: inherit;
      background: var(--gray-100); color: var(--text);
      transition: border-color var(--transition);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(42,125,79,0.12);
      background: var(--white);
    }
    input[readonly] { background: var(--gray-200); color: var(--gray-600); cursor: default; }
    textarea { resize: vertical; }

    .checkbox-row { gap: 1.25rem; flex-wrap: wrap; align-items: center; }
    .checkbox-row label {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.86rem; font-weight: 500; cursor: pointer;
      color: var(--text); text-transform: none; letter-spacing: 0;
    }
    .checkbox-row input[type="checkbox"] { width: 15px; height: 15px; cursor: pointer; }

    .subjects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.35rem 0.75rem;
    }
    .subjects-grid label {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.84rem; cursor: pointer;
      color: var(--text); text-transform: none;
      font-weight: 400; letter-spacing: 0;
    }
    .subjects-grid input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; flex-shrink: 0; }

    /* ===== Delete confirm body ===== */
    #deleteModal .modal-body p { font-size: 0.95rem; line-height: 1.6; }

    /* ===== Footer ===== */
    footer {
      text-align: center; padding: 1.25rem;
      font-size: 0.8rem; color: var(--gray-600);
      border-top: 1px solid var(--gray-200);
      background: var(--white); margin-top: 2rem;
    }

    @media (max-width: 640px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-actions { margin-left: 0; }
      .subjects-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <span class="header-icon">‚öôÔ∏è</span>
      <h1>Admin ‚Äì Program Data Editor</h1>
      <p class="subtitle">Edit, add, or remove camp and afterschool program entries. Download data.js when done and replace the file in the repository.</p>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="search" id="adminSearch" placeholder="Search by name, org, city, or subject‚Ä¶" autocomplete="off" />
      </div>
      <div class="toolbar-actions">
        <span id="dirtyBadge" class="dirty-badge" style="display:none;">‚ö† Unsaved changes</span>
        <button class="btn-secondary" id="btnExport">‚¨á Download data.js</button>
        <button class="btn-primary" id="btnAdd">+ Add Program</button>
      </div>
    </div>

    <p class="stats" id="tableStats"></p>

    <div class="table-wrapper">
      <table id="adminTable">
        <thead>
          <tr>
            <th class="sortable" data-col="name">Name <span class="sort-indicator"></span></th>
            <th class="sortable" data-col="organization">Organization <span class="sort-indicator"></span></th>
            <th class="sortable" data-col="city">City <span class="sort-indicator"></span></th>
            <th class="sortable" data-col="type">Type <span class="sort-indicator"></span></th>
            <th>Grades</th>
            <th class="sortable" data-col="startDate">Start Date <span class="sort-indicator"></span></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- ===== Edit / Add Modal ===== -->
  <div class="modal-overlay" id="editModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h2 id="modalHeading">Edit Program</h2>
        <button class="modal-close" id="editModalClose">‚úï</button>
      </div>
      <form id="editForm">
        <div class="modal-body">

          <!-- Identity -->
          <fieldset>
            <legend>Identity</legend>
            <div class="form-row">
              <div class="form-group full">
                <label for="fName">Name *</label>
                <input type="text" id="fName" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group full">
                <label for="fOrg">Organization *</label>
                <input type="text" id="fOrg" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="fType">Program Type</label>
                <select id="fType">
                  <option value="Summer Camp">Summer Camp</option>
                  <option value="Both">Summer Camp + Pre/After Care</option>
                </select>
              </div>
              <div class="form-group">
                <label for="fSessionType">Session Type</label>
                <input type="text" id="fSessionType" value="Summer" readonly />
              </div>
            </div>
          </fieldset>

          <!-- Location -->
          <fieldset>
            <legend>Location</legend>
            <div class="form-row">
              <div class="form-group full">
                <label for="fAddress">Address</label>
                <input type="text" id="fAddress" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="fCity">City</label>
                <input type="text" id="fCity" />
              </div>
              <div class="form-group narrow">
                <label for="fState">State</label>
                <input type="text" id="fState" maxlength="2" />
              </div>
              <div class="form-group narrow">
                <label for="fZip">Zip</label>
                <input type="text" id="fZip" maxlength="10" />
              </div>
            </div>
          </fieldset>

          <!-- Contact -->
          <fieldset>
            <legend>Contact</legend>
            <div class="form-row">
              <div class="form-group">
                <label for="fPhone">Phone</label>
                <input type="tel" id="fPhone" />
              </div>
              <div class="form-group">
                <label for="fEmail">Email</label>
                <input type="email" id="fEmail" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group full">
                <label for="fWebsite">Website URL</label>
                <input type="url" id="fWebsite" placeholder="https://‚Ä¶" />
              </div>
            </div>
          </fieldset>

          <!-- Grades & Ages -->
          <fieldset>
            <legend>Grades &amp; Ages</legend>
            <div class="form-row">
              <div class="form-group">
                <label for="fGradesMin">Grade Min</label>
                <select id="fGradesMin"></select>
              </div>
              <div class="form-group">
                <label for="fGradesMax">Grade Max</label>
                <select id="fGradesMax"></select>
              </div>
              <div class="form-group">
                <label for="fAgeMin">Age Min</label>
                <input type="number" id="fAgeMin" min="3" max="19" placeholder="‚Äî" />
              </div>
              <div class="form-group">
                <label for="fAgeMax">Age Max</label>
                <input type="number" id="fAgeMax" min="3" max="19" placeholder="‚Äî" />
              </div>
            </div>
          </fieldset>

          <!-- Schedule & Cost -->
          <fieldset>
            <legend>Schedule &amp; Cost</legend>
            <div class="form-row">
              <div class="form-group">
                <label for="fStartDate">Start Date</label>
                <input type="date" id="fStartDate" />
              </div>
              <div class="form-group">
                <label for="fEndDate">End Date</label>
                <input type="date" id="fEndDate" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="fHours">Hours</label>
                <input type="text" id="fHours" placeholder="e.g. 9:00 AM ‚Äì 3:00 PM" />
              </div>
              <div class="form-group">
                <label for="fDays">Days Offered</label>
                <input type="text" id="fDays" placeholder="Mon‚ÄìFri" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="fCost">Cost ($)</label>
                <input type="number" id="fCost" min="0" step="1" placeholder="0 = unknown" />
              </div>
              <div class="form-group">
                <label for="fCostPeriod">Cost Period</label>
                <select id="fCostPeriod">
                  <option value="week">Per Week</option>
                  <option value="day">Per Day</option>
                  <option value="month">Per Month</option>
                  <option value="session">Per Session</option>
                </select>
              </div>
              <div class="form-group">
                <label for="fIndoorOutdoor">Setting</label>
                <select id="fIndoorOutdoor">
                  <option value="Indoor">Indoor</option>
                  <option value="Outdoor">Outdoor</option>
                  <option value="Both">Both</option>
                </select>
              </div>
            </div>
            <div class="form-row checkbox-row">
              <label><input type="checkbox" id="fScholarship" /> Scholarship Available</label>
              <label><input type="checkbox" id="fTransportation" /> Transportation</label>
              <label><input type="checkbox" id="fMeals" /> Meals Provided</label>
              <label><input type="checkbox" id="fAccepting" /> Accepting Registration</label>
            </div>
          </fieldset>

          <!-- Subjects -->
          <fieldset>
            <legend>Subjects &amp; Activities</legend>
            <div class="subjects-grid" id="subjectsGrid"></div>
          </fieldset>

          <!-- Description -->
          <fieldset>
            <legend>Description</legend>
            <div class="form-row">
              <div class="form-group full">
                <label for="fDescription">Description</label>
                <textarea id="fDescription" rows="4"></textarea>
              </div>
            </div>
          </fieldset>

        </div><!-- /modal-body -->

        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="editCancelBtn">Cancel</button>
          <button type="button" class="btn-secondary" id="btnDuplicate" style="display:none;">‚ßâ Duplicate</button>
          <button type="submit" class="btn-primary">Save Program</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Delete Confirmation Modal ===== -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal modal-narrow">
      <div class="modal-header">
        <h2>Delete Program?</h2>
        <button class="modal-close" id="deleteModalClose">‚úï</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="deleteModalName"></strong>? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="deleteCancelBtn">Cancel</button>
        <button class="btn-danger" id="btnConfirmDelete">Delete</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Admin Tool ‚Äì Camp &amp; Afterschool Care Finder &mdash; After exporting, replace <code>data.js</code> in the repository and commit.</p>
  </footer>

  <script src="data.js"></script>
  <script>
    // ===== Constants =====
    const GRADES = ['K','1','2','3','4','5','6','7','8','9','10','11','12'];

    const SUBJECTS = [
      'STEM','Science','Technology','Coding','Math','Chess',
      'Reading','Writing','Arts','Drama','Circus','Music',
      'Dance','Tennis','Martial Arts','Gymnastics','Yoga',
      'Skateboarding','Soccer','Basketball','Volleyball','Hockey',
      'Lacrosse','Baseball','Sports','Mountain Biking','Disc Golf',
      'Ultimate Frisbee','Sailing','Swim','Outdoor Education',
      'Equestrian','Cooking','Animals'
    ];

    const MONTH_ABBR = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    // ===== State =====
    let adminData = programsData.map(p => ({ ...p }));
    let sortCol   = 'name';
    let sortDir   = 'asc';
    let searchQuery = '';
    let editingId   = null;  // null = new entry
    let deletingId  = null;
    let isDirty     = false;

    // ===== Helpers =====
    function subjectToId(s) { return 'subj_' + s.replace(/[^a-zA-Z0-9]/g, '_'); }

    function fmtDate(iso) {
      if (!iso) return '‚Äî';
      const parts = iso.split('-').map(Number);
      return `${MONTH_ABBR[parts[1] - 1]} ${parts[2]}`;
    }

    function gradeRange(p) {
      if (p.gradesMin && p.gradesMax) return `Gr ${p.gradesMin}‚Äì${p.gradesMax}`;
      if (p.ageMin && p.ageMax)       return `Ages ${p.ageMin}‚Äì${p.ageMax}`;
      return '‚Äî';
    }

    function markDirty() {
      isDirty = true;
      document.getElementById('dirtyBadge').style.display = '';
    }

    // ===== Build static elements once =====
    function buildSubjectsGrid() {
      document.getElementById('subjectsGrid').innerHTML = SUBJECTS.map(s =>
        `<label><input type="checkbox" id="${subjectToId(s)}" value="${s}" /> ${s}</label>`
      ).join('');
    }

    function buildGradeSelects() {
      const opts = '<option value="">‚Äî unset ‚Äî</option>' +
        GRADES.map(g => `<option value="${g}">${g === 'K' ? 'Kindergarten' : 'Grade ' + g}</option>`).join('');
      document.getElementById('fGradesMin').innerHTML = opts;
      document.getElementById('fGradesMax').innerHTML = opts;
    }

    // ===== Sort / Filter =====
    function getSortedFiltered() {
      const q = searchQuery.toLowerCase().trim();
      let rows = adminData.filter(p => {
        if (!q) return true;
        return [p.name, p.organization, p.city, p.type, ...(p.subjects || [])]
          .join(' ').toLowerCase().includes(q);
      });

      rows.sort((a, b) => {
        let av = (a[sortCol] ?? '');
        let bv = (b[sortCol] ?? '');
        if (sortCol === 'startDate') {
          if (!av && !bv) return 0;
          if (!av) return 1;
          if (!bv) return -1;
        }
        if (typeof av === 'string') av = av.toLowerCase();
        if (typeof bv === 'string') bv = bv.toLowerCase();
        if (av < bv) return sortDir === 'asc' ? -1 : 1;
        if (av > bv) return sortDir === 'asc' ?  1 : -1;
        return 0;
      });

      return rows;
    }

    // ===== Render Table =====
    function renderTable() {
      const rows = getSortedFiltered();
      const tbody = document.getElementById('adminTbody');

      tbody.innerHTML = rows.map(p => {
        const badgeClass = p.type === 'Summer Camp' ? 'badge-camp' : 'badge-both';
        const typeLabel  = p.type === 'Summer Camp' ? 'Camp' : 'Camp+Care';
        return `<tr>
          <td class="td-name"><span class="td-trunc" title="${esc(p.name)}">${esc(p.name)}</span></td>
          <td class="td-org"><span class="td-trunc" title="${esc(p.organization)}">${esc(p.organization)}</span></td>
          <td>${esc(p.city || '‚Äî')}</td>
          <td><span class="type-badge ${badgeClass}">${typeLabel}</span></td>
          <td>${esc(gradeRange(p))}</td>
          <td>${fmtDate(p.startDate)}</td>
          <td><div class="td-actions">
            <button class="btn-icon edit" data-id="${p.id}">‚úè Edit</button>
            <button class="btn-icon del"  data-id="${p.id}">‚úï Delete</button>
          </div></td>
        </tr>`;
      }).join('');

      // Attach row button listeners
      tbody.querySelectorAll('.btn-icon.edit').forEach(btn =>
        btn.addEventListener('click', () => openEditModal(parseInt(btn.dataset.id)))
      );
      tbody.querySelectorAll('.btn-icon.del').forEach(btn =>
        btn.addEventListener('click', () => confirmDelete(parseInt(btn.dataset.id)))
      );

      // Update sort indicators
      document.querySelectorAll('thead th[data-col]').forEach(th => {
        const ind = th.querySelector('.sort-indicator');
        if (th.dataset.col === sortCol) {
          th.classList.add('sort-active');
          ind.textContent = sortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        } else {
          th.classList.remove('sort-active');
          ind.textContent = '';
        }
      });

      updateStats(rows.length);
    }

    function esc(str) {
      return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function updateStats(shown) {
      const el = document.getElementById('tableStats');
      const total = adminData.length;
      if (shown === undefined) shown = getSortedFiltered().length;
      el.innerHTML = `Showing <strong>${shown}</strong> of <strong>${total}</strong> programs`;
    }

    // ===== Sort =====
    function handleSort(col) {
      if (sortCol === col) {
        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        sortCol = col;
        sortDir = 'asc';
      }
      renderTable();
    }

    // ===== Blank Program =====
    function blankProgram() {
      return {
        id: null, name: '', type: 'Summer Camp', organization: '',
        address: '', city: '', state: 'VT', zip: '',
        phone: '', email: '', website: '',
        gradesMin: '', gradesMax: '', ageMin: null, ageMax: null,
        cost: 0, costPeriod: 'session', scholarshipAvailable: false,
        hours: '', daysOffered: 'Mon‚ÄìFri', sessionType: 'Summer',
        subjects: [], description: '', indoorOutdoor: 'Both',
        transportation: false, mealsProvided: false,
        acceptingRegistration: true, startDate: '', endDate: ''
      };
    }

    // ===== Edit Modal =====
    function openEditModal(id) {
      editingId = id;
      const p = id === null ? blankProgram() : adminData.find(x => x.id === id);

      document.getElementById('modalHeading').textContent = id === null ? 'Add Program' : 'Edit Program';
      document.getElementById('fName').value        = p.name || '';
      document.getElementById('fOrg').value         = p.organization || '';
      document.getElementById('fType').value        = p.type || 'Summer Camp';
      document.getElementById('fSessionType').value = p.sessionType || 'Summer';
      document.getElementById('fAddress').value     = p.address || '';
      document.getElementById('fCity').value        = p.city || '';
      document.getElementById('fState').value       = p.state || 'VT';
      document.getElementById('fZip').value         = p.zip || '';
      document.getElementById('fPhone').value       = p.phone || '';
      document.getElementById('fEmail').value       = p.email || '';
      document.getElementById('fWebsite').value     = p.website || '';
      document.getElementById('fGradesMin').value   = p.gradesMin || '';
      document.getElementById('fGradesMax').value   = p.gradesMax || '';
      document.getElementById('fAgeMin').value      = p.ageMin != null ? p.ageMin : '';
      document.getElementById('fAgeMax').value      = p.ageMax != null ? p.ageMax : '';
      document.getElementById('fStartDate').value   = p.startDate || '';
      document.getElementById('fEndDate').value     = p.endDate || '';
      document.getElementById('fHours').value       = p.hours || '';
      document.getElementById('fDays').value        = p.daysOffered || 'Mon‚ÄìFri';
      document.getElementById('fCost').value        = p.cost != null ? p.cost : '';
      document.getElementById('fCostPeriod').value  = p.costPeriod || 'session';
      document.getElementById('fIndoorOutdoor').value = p.indoorOutdoor || 'Both';
      document.getElementById('fScholarship').checked   = !!p.scholarshipAvailable;
      document.getElementById('fTransportation').checked = !!p.transportation;
      document.getElementById('fMeals').checked         = !!p.mealsProvided;
      document.getElementById('fAccepting').checked     = p.acceptingRegistration !== false;
      document.getElementById('fDescription').value  = p.description || '';

      const subs = p.subjects || [];
      SUBJECTS.forEach(s => {
        const cb = document.getElementById(subjectToId(s));
        if (cb) cb.checked = subs.includes(s);
      });

      document.getElementById('btnDuplicate').style.display = id === null ? 'none' : '';
      openModal('editModal');
      document.getElementById('fName').focus();
    }

    function readFormIntoObject() {
      const ageMinVal = document.getElementById('fAgeMin').value;
      const ageMaxVal = document.getElementById('fAgeMax').value;
      const costVal   = document.getElementById('fCost').value;

      const subjects = SUBJECTS.filter(s => {
        const cb = document.getElementById(subjectToId(s));
        return cb && cb.checked;
      });

      return {
        id:                   editingId,
        name:                 document.getElementById('fName').value.trim(),
        type:                 document.getElementById('fType').value,
        organization:         document.getElementById('fOrg').value.trim(),
        address:              document.getElementById('fAddress').value.trim(),
        city:                 document.getElementById('fCity').value.trim(),
        state:                document.getElementById('fState').value.trim() || 'VT',
        zip:                  document.getElementById('fZip').value.trim(),
        phone:                document.getElementById('fPhone').value.trim(),
        email:                document.getElementById('fEmail').value.trim(),
        website:              document.getElementById('fWebsite').value.trim(),
        gradesMin:            document.getElementById('fGradesMin').value,
        gradesMax:            document.getElementById('fGradesMax').value,
        ageMin:               ageMinVal ? parseInt(ageMinVal, 10) : null,
        ageMax:               ageMaxVal ? parseInt(ageMaxVal, 10) : null,
        cost:                 costVal ? parseInt(costVal, 10) : 0,
        costPeriod:           document.getElementById('fCostPeriod').value,
        scholarshipAvailable: document.getElementById('fScholarship').checked,
        hours:                document.getElementById('fHours').value.trim(),
        daysOffered:          document.getElementById('fDays').value.trim(),
        sessionType:          'Summer',
        subjects:             subjects,
        description:          document.getElementById('fDescription').value.trim(),
        indoorOutdoor:        document.getElementById('fIndoorOutdoor').value,
        transportation:       document.getElementById('fTransportation').checked,
        mealsProvided:        document.getElementById('fMeals').checked,
        acceptingRegistration: document.getElementById('fAccepting').checked,
        startDate:            document.getElementById('fStartDate').value,
        endDate:              document.getElementById('fEndDate').value,
      };
    }

    function handleSave(e) {
      e.preventDefault();
      const entry = readFormIntoObject();

      if (editingId === null) {
        entry.id = Math.max(0, ...adminData.map(p => p.id)) + 1;
        adminData.push(entry);
      } else {
        const idx = adminData.findIndex(p => p.id === editingId);
        if (idx >= 0) adminData[idx] = entry;
      }

      markDirty();
      closeModal('editModal');
      renderTable();
    }

    // ===== Delete =====
    function confirmDelete(id) {
      deletingId = id;
      const p = adminData.find(x => x.id === id);
      document.getElementById('deleteModalName').textContent = p ? p.name : '';
      openModal('deleteModal');
    }

    function executeDelete() {
      adminData = adminData.filter(p => p.id !== deletingId);
      markDirty();
      closeModal('deleteModal');
      renderTable();
    }

    // ===== Export =====
    function exportDataJs() {
      const json = JSON.stringify(adminData, null, 2);
      const content = `const programsData = ${json};\n`;
      const blob = new Blob([content], { type: 'text/javascript' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'data.js';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      // Clear dirty flag after successful export
      isDirty = false;
      document.getElementById('dirtyBadge').style.display = 'none';
    }

    // ===== Modal helpers =====
    function openModal(id) {
      document.getElementById(id).classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove('open');
      document.body.style.overflow = '';
    }

    // ===== Init =====
    buildSubjectsGrid();
    buildGradeSelects();
    renderTable();

    // Toolbar buttons
    document.getElementById('btnAdd').addEventListener('click', () => openEditModal(null));
    document.getElementById('btnExport').addEventListener('click', exportDataJs);
    document.getElementById('btnConfirmDelete').addEventListener('click', executeDelete);

    // Search
    document.getElementById('adminSearch').addEventListener('input', e => {
      searchQuery = e.target.value;
      renderTable();
    });

    // Sortable columns
    document.querySelectorAll('thead th[data-col]').forEach(th =>
      th.addEventListener('click', () => handleSort(th.dataset.col))
    );

    // Duplicate button
    document.getElementById('btnDuplicate').addEventListener('click', () => {
      const entry = readFormIntoObject();
      entry.id = Math.max(0, ...adminData.map(p => p.id)) + 1;
      entry.name = entry.name + ' (Copy)';
      adminData.push(entry);
      markDirty();
      closeModal('editModal');
      renderTable();
    });

    // Edit form submit
    document.getElementById('editForm').addEventListener('submit', handleSave);

    // Modal close buttons
    document.getElementById('editModalClose').addEventListener('click', () => closeModal('editModal'));
    document.getElementById('editCancelBtn').addEventListener('click', () => closeModal('editModal'));
    document.getElementById('deleteModalClose').addEventListener('click', () => closeModal('deleteModal'));
    document.getElementById('deleteCancelBtn').addEventListener('click', () => closeModal('deleteModal'));

    // Backdrop click closes
    ['editModal', 'deleteModal'].forEach(id => {
      document.getElementById(id).addEventListener('click', e => {
        if (e.target.id === id) closeModal(id);
      });
    });

    // Esc key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal('editModal');
        closeModal('deleteModal');
      }
    });

    // Unsaved changes warning
    window.addEventListener('beforeunload', e => {
      if (isDirty) { e.preventDefault(); e.returnValue = ''; }
    });
  </script>
</body>
</html>
